<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#111111">
  <title>clive</title>

  <!-- Favicons -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512x512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- xterm.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/css/xterm.css">
  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0/lib/addon-fit.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0/lib/addon-web-links.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-webgl@0/lib/addon-webgl.js"></script>

  <style>
    /* ── Variables ── */
    :root {
      /* Dark theme (terminal view) */
      --bg-primary:    #111111;
      --bg-secondary:  #1A1A1A;
      --bg-card:       #161616;
      --border-color:  #2A2A2A;
      --text-primary:  #EEEEEE;
      --text-secondary:#666666;
      --accent:        #D97757;
      --accent-hover:  #C96442;
      --status-green:  #30A46C;
      --status-red:    #E5484D;
      --status-amber:  #F76B15;
      --font-ui:       'DM Sans', 'JetBrains Mono', sans-serif;
      --font-mono:     'JetBrains Mono', 'Fira Code', monospace;
      --header-h:      52px;
      --pill-h:        52px;
      --pill-gap:      10px;
      /* Light theme (launch screen) */
      --launch-bg:        #FFFFFF;
      --launch-bg2:       #F8F9FA;
      --launch-border:    #DADCE0;
      --launch-text:      #202124;
      --launch-text2:     #5F6368;
      --launch-accent:    #A14A36;
      --launch-accent-h:  #8B3E2D;
      --launch-accent-lt: #FFF2F0;
    }

    /* ── Reset ── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { background: #111111; }
    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: var(--font-ui);
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Views ── */
    #launch-screen, #terminal-view {
      position: fixed;
      inset: 0;
      transition: opacity 0.2s ease;
    }
    #launch-screen {
      display: flex;
      flex-direction: column;
      background: var(--launch-bg);
      color: var(--launch-text);
      z-index: 10;
      overflow: hidden;
      font-family: var(--font-ui);
    }
    #terminal-view {
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      z-index: 5;
    }
    .hidden { opacity: 0; pointer-events: none; }


    /* ══════════════════════════════════════════════════
       LAUNCH SCREEN — Light theme
    ══════════════════════════════════════════════════ */

    /* ── Launch Header (sticky) ── */
    #launch-header {
      flex-shrink: 0;
      padding: 40px 24px 0;
      background: var(--launch-bg);
      border-bottom: 1px solid var(--launch-border);
      display: flex;
      flex-direction: column;
      gap: 24px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* ── CLIVE Logo ── */
    #clive-logo {
      font-size: 10px;
      line-height: 1.1;
      font-family: var(--font-mono);
      letter-spacing: -0.04em;
      pointer-events: none;
      user-select: none;
      white-space: pre;
    }
    @media (min-width: 400px) { #clive-logo { font-size: 11px; } }
    .logo-cli { color: #A14A36; }
    .logo-ve  { color: #D18B7A; }

    /* ── Tab Switcher ── */
    #tab-switcher {
      display: flex;
      gap: 32px;
    }
    .tab-btn {
      padding-bottom: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--launch-text2);
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      font-family: var(--font-ui);
    }
    .tab-btn:hover { color: var(--launch-text); }
    .tab-btn.active { color: var(--launch-accent); }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--launch-accent);
      border-radius: 3px 3px 0 0;
    }

    /* ── Path Row ── */
    #path-row {
      flex-shrink: 0;
      padding: 16px 24px;
    }
    #path-display {
      font-size: 14px;
      font-weight: 500;
      color: var(--launch-text2);
      font-family: var(--font-mono);
    }

    /* ── Browser List ── */
    #browser-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 16px 160px;
    }
    #browser-list::-webkit-scrollbar { display: none; }

    .browser-entry {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      color: var(--launch-text);
      transition: background 0.1s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      background: none;
      border: none;
      border-radius: 16px;
      width: 100%;
      text-align: left;
    }
    .browser-entry:active { background: var(--launch-bg2); }
    .browser-entry:hover  { background: var(--launch-bg2); }
    .browser-entry.file   { cursor: default; }

    .entry-left {
      display: flex;
      align-items: center;
      gap: 20px;
      min-width: 0;
    }
    .entry-icon {
      flex-shrink: 0;
      color: var(--launch-text2);
      transition: color 0.1s;
      display: flex;
      align-items: center;
    }
    .browser-entry:hover .entry-icon { color: var(--launch-accent); }
    .entry-text {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .entry-name {
      font-size: 15px;
      font-weight: 500;
      color: var(--launch-text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: var(--font-ui);
    }
    .entry-meta {
      font-size: 12px;
      color: var(--launch-text2);
      opacity: 0.7;
      font-family: var(--font-mono);
      white-space: nowrap;
    }

    .browser-loading, .browser-error {
      padding: 20px 12px;
      text-align: center;
      font-size: 13px;
      color: var(--launch-text2);
    }
    .browser-error { color: var(--status-red); }
    .browser-spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid var(--launch-border);
      border-top-color: var(--launch-accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    /* ── Session Cards (tmux mode) ── */
    .session-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      background: none;
      border: none;
      border-radius: 16px;
      width: 100%;
      text-align: left;
      transition: background 0.1s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      color: var(--launch-text);
    }
    .session-card:hover  { background: var(--launch-bg2); }
    .session-card:active { background: var(--launch-bg2); }
    .session-card.selected {
      background: var(--launch-accent-lt);
      outline: 1px solid rgba(161,74,54,0.35);
      outline-offset: -1px;
    }
    .session-card-left {
      display: flex;
      align-items: center;
      gap: 20px;
      min-width: 0;
    }
    .session-icon {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--launch-bg2);
      color: var(--launch-text2);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.1s, color 0.1s;
    }
    .session-card.selected .session-icon,
    .session-card:hover .session-icon {
      background: var(--launch-accent-lt);
      color: var(--launch-accent);
    }
    .session-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .session-card-name {
      font-size: 15px;
      font-weight: 500;
      color: var(--launch-text);
      font-family: var(--font-ui);
    }
    .session-card-meta {
      font-size: 12px;
      color: var(--launch-text2);
      opacity: 0.7;
      font-family: var(--font-mono);
    }
    .session-badge {
      font-size: 11px;
      font-weight: 700;
      background: var(--launch-accent-lt);
      color: var(--launch-accent);
      padding: 2px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      flex-shrink: 0;
    }
    .sessions-empty {
      padding: 40px 12px;
      text-align: center;
      font-size: 13px;
      color: var(--launch-text2);
      font-family: var(--font-ui);
    }

    /* ── Bottom Launch Bar ── */
    #bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 20;
      pointer-events: none;
      /* Fade gradient */
      background: linear-gradient(to top, #ffffff 60%, rgba(255,255,255,0.9) 85%, transparent 100%);
      padding: 24px 24px 32px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }
    #bottom-bar-inner {
      background: #ffffff;
      border: 1px solid var(--launch-border);
      padding: 8px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 1px 2px rgba(60,64,67,0.302), 0 1px 3px 1px rgba(60,64,67,0.149);
      width: 100%;
      max-width: 380px;
      pointer-events: auto;
    }
    .runner-toggle {
      display: flex;
      background: var(--launch-bg2);
      border: 1px solid var(--launch-border);
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
      flex-shrink: 0;
    }
    .runner-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.4;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      color: var(--launch-text);
    }
    .runner-btn:hover { opacity: 0.7; }
    .runner-btn.active {
      background: var(--launch-accent);
      color: #ffffff;
      opacity: 1;
      box-shadow: 0 2px 8px rgba(161,74,54,0.35);
    }
    #start-btn {
      flex: 1;
      height: 48px;
      background: var(--launch-accent);
      color: #ffffff;
      border: none;
      border-radius: 999px;
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s, transform 0.08s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 12px;
    }
    #start-btn:hover { background: var(--launch-accent-h); }
    #start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #start-btn:active:not(:disabled) { transform: scale(0.99); }

    /* ── Font Size Buttons ── */
    .font-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      min-width: 30px;
      min-height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: color 0.15s, background 0.1s;
      font-family: var(--font-ui);
      font-weight: 600;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .font-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.06); }
    .font-btn:active { opacity: 0.6; }
    .font-btn:disabled { opacity: 0.25; cursor: default; background: none; }
    #font-dec { font-size: 12px; }
    #font-inc { font-size: 16px; }

    /* ── Mkdir Floating Button ── */
    #mkdir-btn {
      position: fixed;
      display: none; /* shown by JS only in remote tab on launch screen */
      bottom: 112px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #ffffff;
      border: 1px solid var(--launch-border);
      box-shadow: 0 1px 2px rgba(60,64,67,0.302), 0 1px 3px 1px rgba(60,64,67,0.149);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--launch-accent);
      cursor: pointer;
      transition: box-shadow 0.15s, transform 0.08s;
      z-index: 21;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }
    #mkdir-btn:hover {
      box-shadow: 0 4px 12px rgba(60,64,67,0.25), 0 2px 6px rgba(60,64,67,0.15);
    }
    #mkdir-btn:active { transform: scale(0.93); }

    /* ── Clone Floating Button ── */
    #clone-btn {
      position: fixed;
      display: none; /* shown by JS only in remote tab on launch screen */
      bottom: 180px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #ffffff;
      border: 1px solid var(--launch-border);
      box-shadow: 0 1px 2px rgba(60,64,67,0.302), 0 1px 3px 1px rgba(60,64,67,0.149);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--launch-accent);
      cursor: pointer;
      transition: box-shadow 0.15s, transform 0.08s;
      z-index: 21;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }
    #clone-btn:hover {
      box-shadow: 0 4px 12px rgba(60,64,67,0.25), 0 2px 6px rgba(60,64,67,0.15);
    }
    #clone-btn:active { transform: scale(0.93); }

    /* ── Clone Modal ── */
    #clone-scrim {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 70;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    #clone-scrim.visible { opacity: 1; pointer-events: auto; }
    #clone-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -48%) scale(0.96);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 71;
      background: #ffffff;
      border: 1px solid var(--launch-border);
      border-radius: 20px;
      padding: 24px;
      width: calc(100% - 48px);
      max-width: 360px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 8px 32px rgba(60,64,67,0.18);
    }
    #clone-modal.open {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    #clone-modal-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--launch-text2);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-family: var(--font-ui);
    }
    #clone-url-input, #clone-dest-input {
      width: 100%;
      background: var(--launch-bg2);
      border: 1px solid var(--launch-border);
      border-radius: 10px;
      padding: 12px 14px;
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--launch-text);
      outline: none;
      transition: border-color 0.15s;
    }
    #clone-url-input:focus, #clone-dest-input:focus { border-color: var(--launch-accent); }
    #clone-url-input::placeholder, #clone-dest-input::placeholder { color: var(--launch-border); }
    #clone-status {
      font-size: 12px;
      text-align: center;
      min-height: 16px;
      color: var(--launch-text2);
    }
    #clone-status.cloning {
      color: var(--status-amber);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    #clone-status.cloning::before {
      content: '';
      display: inline-block;
      width: 12px; height: 12px;
      border: 2px solid var(--launch-border);
      border-top-color: var(--status-amber);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    #clone-status.error { color: var(--status-red); }
    #clone-submit-btn {
      background: var(--launch-accent);
      color: #ffffff;
    }
    #clone-submit-btn:hover { background: var(--launch-accent-h); }
    #clone-submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ── Mkdir Modal ── */
    #mkdir-scrim {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 70;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    #mkdir-scrim.visible { opacity: 1; pointer-events: auto; }

    #mkdir-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -48%) scale(0.96);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 71;
      background: #ffffff;
      border: 1px solid var(--launch-border);
      border-radius: 20px;
      padding: 24px;
      width: calc(100% - 48px);
      max-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 8px 32px rgba(60,64,67,0.18);
    }
    #mkdir-modal.open {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    #mkdir-modal-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--launch-text2);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-family: var(--font-ui);
    }
    #mkdir-input {
      width: 100%;
      background: var(--launch-bg2);
      border: 1px solid var(--launch-border);
      border-radius: 10px;
      padding: 12px 14px;
      font-family: var(--font-mono);
      font-size: 15px;
      color: var(--launch-text);
      outline: none;
      transition: border-color 0.15s;
    }
    #mkdir-input:focus { border-color: var(--launch-accent); }
    #mkdir-input::placeholder { color: var(--launch-border); }
    .mkdir-actions {
      display: flex;
      gap: 8px;
    }
    .mkdir-actions button {
      flex: 1;
      height: 44px;
      border-radius: 999px;
      border: none;
      font-family: var(--font-ui);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.08s;
      -webkit-tap-highlight-color: transparent;
    }
    .mkdir-actions button:active { transform: scale(0.97); }
    #mkdir-cancel-btn {
      background: var(--launch-bg2);
      color: var(--launch-text2);
      border: 1px solid var(--launch-border);
    }
    #mkdir-cancel-btn:hover { color: var(--launch-text); }
    #mkdir-create-btn {
      background: var(--launch-accent);
      color: #ffffff;
    }
    #mkdir-create-btn:hover { background: var(--launch-accent-h); }
    #mkdir-create-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    #mkdir-error {
      font-size: 12px;
      color: var(--status-red);
      text-align: center;
      min-height: 16px;
    }


    /* ══════════════════════════════════════════════════
       TERMINAL VIEW — Dark theme (unchanged)
    ══════════════════════════════════════════════════ */

    /* ── Header ── */
    #header {
      height: var(--header-h);
      min-height: var(--header-h);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
      z-index: 20;
      position: relative;
    }
    .header-wordmark {
      font-family: var(--font-ui);
      font-size: 17px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: -0.2px;
      display: flex;
      align-items: center;
    }
    .header-right { display: flex; align-items: center; gap: 12px; }

    /* ── Hamburger button ── */
    #menu-btn {
      width: 38px;
      height: 38px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: color 0.15s, background 0.1s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    #menu-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.06); }
    #menu-btn:active { opacity: 0.6; }

    /* ── Header dropdown menu ── */
    #header-menu-scrim {
      position: fixed;
      inset: 0;
      z-index: 48;
      display: none;
    }
    #header-menu-scrim.open { display: block; }

    #header-menu {
      position: fixed;
      top: calc(var(--header-h) + 6px);
      right: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      z-index: 49;
      min-width: 200px;
      overflow: hidden;
      opacity: 0;
      transform: translateY(-6px) scale(0.97);
      pointer-events: none;
      transition: opacity 0.15s, transform 0.15s;
      transform-origin: top right;
    }
    #header-menu.open {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      background: none;
      border: none;
      color: var(--text-primary);
      font-family: var(--font-ui);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-align: left;
      transition: background 0.1s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .menu-item + .menu-item { border-top: 1px solid var(--border-color); }
    .menu-item:hover { background: rgba(255,255,255,0.05); }
    .menu-item:active { background: rgba(255,255,255,0.09); }
    .menu-item svg { flex-shrink: 0; color: var(--text-secondary); }
    #kill-btn.confirm { color: var(--status-red); }
    #kill-btn.confirm svg { color: var(--status-red); }

    /* ── Terminal Container ── */
    #terminal-wrap {
      flex: 1;
      overflow: hidden;
      position: relative;
      padding: 8px;
    }
    #terminal-container {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
      background: #111111;
    }
    @media (max-width: 767px) {
      #terminal-wrap { padding: 0; }
      #terminal-container { border-radius: 0; box-shadow: none; }
    }
    /* xterm overrides */
    .xterm { height: 100%; }
    .xterm-screen { margin: 0 auto; }
    .xterm-viewport { overflow-y: auto !important; }
    .xterm-viewport::-webkit-scrollbar { width: 6px; }
    .xterm-viewport::-webkit-scrollbar-track { background: transparent; }
    .xterm-viewport::-webkit-scrollbar-thumb { background: rgba(150,150,150,0.2); border-radius: 3px; }

    /* ── Mobile Toolbar Row ── */
    #mobile-toolbar {
      display: none;
      position: fixed;
      bottom: var(--pill-gap);
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 24px);
      max-width: 560px;
      align-items: center;
      gap: 8px;
      z-index: 40;
    }
    .mobile-show #mobile-toolbar { display: flex; }

    /* ── Toolbar Pill ── */
    #toolbar-pill {
      flex: 1;
      height: var(--pill-h);
      background: rgba(22, 22, 22, 0.97);
      border: 1px solid var(--border-color);
      border-radius: calc(var(--pill-h) / 2);
      box-shadow: 0 4px 24px rgba(0,0,0,0.13), 0 1px 4px rgba(0,0,0,0.07);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow: hidden;
      display: flex;
      align-items: center;
      padding: 0 6px;
      gap: 0;
    }

    /* ── Compose Circle Button ── */
    #tb-compose {
      flex-shrink: 0;
      width: var(--pill-h);
      height: var(--pill-h);
      border-radius: 50%;
      background: rgba(22, 22, 22, 0.97);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 24px rgba(0,0,0,0.13), 0 1px 4px rgba(0,0,0,0.07);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      cursor: pointer;
      transition: color 0.08s, transform 0.08s, background 0.08s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }
    #tb-compose:active {
      background: var(--accent);
      color: #fff;
      transform: scale(0.88);
    }

    .tb-btn {
      flex: 1;
      min-width: 0;
      height: 40px;
      padding: 0;
      background: transparent;
      border: none;
      font-family: var(--font-mono);
      font-size: 13px;
      color: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      transition: color 0.08s, transform 0.08s, background 0.08s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      border-radius: 999px;
    }
    .tb-btn:active {
      background: var(--accent);
      color: #fff;
      transform: scale(0.88);
    }
    .tb-btn.ctrl-active { color: var(--accent); }
    .tb-btn.sym { font-size: 15px; }

    /* ── Reconnect Overlay ── */
    #reconnect-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: rgba(17,17,17,0.88);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #reconnect-overlay.visible { opacity: 1; pointer-events: auto; }
    .reconnect-spinner {
      width: 28px; height: 28px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .reconnect-text { font-size: 14px; color: var(--text-secondary); font-weight: 500; }

    /* ── Hidden mobile input ── */
    #mobile-input {
      position: fixed;
      top: -9999px; left: -9999px;
      opacity: 0;
      width: 1px; height: 1px;
      resize: none;
      border: none;
      outline: none;
    }

    /* ── Compose Scrim ── */
    #compose-scrim {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 59;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }
    #compose-scrim.visible { opacity: 1; pointer-events: auto; }

    /* ── Compose Overlay — bottom sheet ── */
    #compose-overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 60;
      display: flex;
      flex-direction: column;
      background: rgba(22, 22, 22, 0.92);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-top: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px 20px 0 0;
      transform: translateY(100vh);
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #compose-overlay.open { transform: translateY(0); }

    #compose-body { padding: 14px 16px; }
    #compose-box { position: relative; }
    #compose-textarea {
      display: block;
      width: 100%;
      resize: none;
      border: 1.5px solid rgba(255,255,255,0.2);
      border-radius: 24px;
      padding: 14px 52px 52px 16px;
      font-family: var(--font-mono);
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--bg-secondary);
      outline: none;
      min-height: calc(33vh - 60px);
      overflow-y: hidden;
    }
    #compose-textarea::placeholder { color: var(--text-secondary); }

    #compose-cancel {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255,255,255,0.08);
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: background 0.12s, color 0.12s;
    }
    #compose-cancel:hover { background: rgba(255,255,255,0.14); color: var(--text-primary); }

    #compose-send {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: background 0.15s, transform 0.08s;
    }
    #compose-send:hover { background: var(--accent-hover); }
    #compose-send:active { transform: scale(0.92); }

    /* ── Gemini mode overrides ── */
    #terminal-view.gemini-mode .header-wordmark { color: #4285F4; }

    /* ── Animations ── */
    @keyframes spin  { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  </style>
</head>
<body>

<!-- ══════════════════════════════════════════════════════════
     LAUNCH SCREEN
══════════════════════════════════════════════════════════════ -->
<div id="launch-screen">

  <div id="launch-header">
    <!-- CLIVE Logo -->
    <pre id="clive-logo"><span class="logo-cli"> ██████╗██╗     ██╗</span><span class="logo-ve">██╗   ██╗███████╗</span>
<span class="logo-cli">██╔════╝██║     ██║</span><span class="logo-ve">██║   ██║██╔════╝</span>
<span class="logo-cli">██║     ██║     ██║</span><span class="logo-ve">██║   ██║█████╗  </span>
<span class="logo-cli">██║     ██║     ██║</span><span class="logo-ve">╚██╗ ██╔╝██╔══╝  </span>
<span class="logo-cli">╚██████╗███████╗██║</span><span class="logo-ve"> ╚████╔╝ ███████╗</span>
<span class="logo-cli"> ╚═════╝╚══════╝╚═╝</span><span class="logo-ve">  ╚═══╝  ╚══════╝</span></pre>

    <!-- Tab Switcher -->
    <div id="tab-switcher">
      <button class="tab-btn active" data-tab="remote">Remote Drive</button>
      <button class="tab-btn" data-tab="tmux">Tmux</button>
    </div>
  </div>

  <!-- Path display (below sticky header) -->
  <div id="path-row">
    <span id="path-display">/</span>
  </div>

  <div id="browser-list">
    <div class="browser-loading"><span class="browser-spinner"></span> Loading…</div>
  </div>

  <div id="bottom-bar">
    <div id="bottom-bar-inner">
      <div class="runner-toggle">
        <button class="runner-btn active" data-cli="claude">
          <svg width="20" height="20"><use href="/icons.svg#icon-claude"/></svg>
        </button>
        <button class="runner-btn" data-cli="gemini">
          <svg width="20" height="20"><use href="/icons.svg#icon-gemini"/></svg>
        </button>
      </div>
      <button id="start-btn">START SESSION</button>
    </div>
  </div>

</div>

<!-- Mkdir floating button (outside launch-screen so it's above bottom-bar gradient) -->
<button id="mkdir-btn" title="New folder">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
  </svg>
</button>

<!-- Clone floating button -->
<button id="clone-btn" title="Clone repository">
  <svg width="22" height="22"><use href="/icons.svg#icon-github"/></svg>
</button>

<!-- ══════════════════════════════════════════════════════════
     MKDIR MODAL
══════════════════════════════════════════════════════════════ -->
<div id="mkdir-scrim"></div>
<div id="mkdir-modal">
  <div id="mkdir-modal-title">New Folder</div>
  <input id="mkdir-input" type="text" placeholder="folder-name"
    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <div id="mkdir-error"></div>
  <div class="mkdir-actions">
    <button id="mkdir-cancel-btn">Cancel</button>
    <button id="mkdir-create-btn">Create</button>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════
     CLONE MODAL
══════════════════════════════════════════════════════════════ -->
<div id="clone-scrim"></div>
<div id="clone-modal">
  <div id="clone-modal-title">Clone Repository</div>
  <input id="clone-url-input" type="url" placeholder="https://github.com/user/repo"
    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <input id="clone-dest-input" type="text" placeholder="Destination folder (optional)"
    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <div id="clone-status"></div>
  <div class="mkdir-actions">
    <button id="clone-cancel-btn">Cancel</button>
    <button id="clone-submit-btn">Clone</button>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════
     TERMINAL VIEW
══════════════════════════════════════════════════════════════ -->
<div id="terminal-view" class="hidden">

  <header id="header">
    <div class="header-wordmark" id="header-wordmark"></div>
    <div class="header-right">
      <button id="menu-btn" title="Menu" aria-label="Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
    </div>
  </header>

  <div id="terminal-wrap">
    <div id="terminal-container"></div>
  </div>

</div>

<!-- Header menu scrim + dropdown (outside header to avoid stacking-context trap) -->
<div id="header-menu-scrim"></div>
<div id="header-menu">
  <button class="menu-item" id="font-inc">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
    Larger Text
  </button>
  <button class="menu-item" id="font-dec">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 14 4 14 7"/><line x1="7" y1="20" x2="11" y2="20"/><line x1="9" y1="4" x2="9" y2="20"/><line x1="17" y1="12" x2="23" y2="12"/></svg>
    Smaller Text
  </button>
  <button class="menu-item" id="detach-btn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    Detach
  </button>
  <button class="menu-item" id="kill-btn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    <span id="kill-btn-label">End Session</span>
  </button>
</div>

<!-- Floating toolbar row (outside terminal-view, position: fixed) -->
<div id="mobile-toolbar">
  <div id="toolbar-pill">
    <button class="tb-btn" data-key="&#x03;">^C</button>
    <button class="tb-btn" data-key="&#x1b;">Esc</button>
    <button class="tb-btn" id="tb-ctrl">Ctrl</button>
    <button class="tb-btn" data-key="&#x09;">Tab</button>
    <button class="tb-btn sym" data-key="&#x1b;[D">◀</button>
    <button class="tb-btn sym" data-key="&#x1b;[A">▲</button>
    <button class="tb-btn sym" data-key="&#x1b;[B">▼</button>
    <button class="tb-btn sym" data-key="&#x1b;[C">▶</button>
    <button class="tb-btn sym" data-key="&#x0d;">↵</button>
  </div>
  <button id="tb-compose">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
  </button>
</div>

<!-- ══════════════════════════════════════════════════════════
     COMPOSE SCRIM + OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="compose-scrim"></div>
<div id="compose-overlay">
  <div id="compose-body">
    <div id="compose-box">
      <textarea id="compose-textarea"
        placeholder="Type your command or message…"
        autocomplete="off" autocorrect="off" autocapitalize="off"
        spellcheck="false"></textarea>
      <button id="compose-cancel">✕</button>
      <button id="compose-send">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════
     RECONNECT OVERLAY
══════════════════════════════════════════════════════════════ -->
<div id="reconnect-overlay">
  <div class="reconnect-spinner"></div>
  <div class="reconnect-text">Reconnecting…</div>
</div>

<textarea id="mobile-input"
  autocomplete="off" autocorrect="off" autocapitalize="off"
  spellcheck="false" inputmode="none" tabindex="-1" rows="1"></textarea>

<script>
'use strict';

// ── State ──────────────────────────────────────────────────────────────────────
const state = {
  browsePath: '',
  browseRoot: null,
  selectedCli: 'claude',
  selectedSession: null,
  sessionActive: false,
  wsConnected: false,
  ws: null,
  reconnectAttempt: 0,
  reconnectTimer: null,
  reconnectOverlayTimer: null,
  killConfirmTimer: null,
  killConfirmPending: false,
  ctrlMode: false,
  activeTab: 'remote',  // 'remote' | 'tmux'
  isMobile: ('ontouchstart' in window) || window.innerWidth < 768,
};

// ── Font size ──────────────────────────────────────────────────────────────────
const FONT_SIZE_MIN = 10, FONT_SIZE_MAX = 20;
const FONT_SIZE_KEY = 'vibeterm-fontSize';

function loadFontSize() {
  const saved = parseInt(localStorage.getItem(FONT_SIZE_KEY), 10);
  return (saved >= FONT_SIZE_MIN && saved <= FONT_SIZE_MAX) ? saved : (state.isMobile ? 12 : 13);
}

// ── DOM refs ───────────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const launchScreen     = $('launch-screen');
const terminalView     = $('terminal-view');
const terminalWrap     = $('terminal-wrap');
const pathDisplay      = $('path-display');
const pathRow          = $('path-row');
const browserList      = $('browser-list');
const startBtn         = $('start-btn');
const killBtn          = $('kill-btn');
const detachBtn        = $('detach-btn');
const headerWordmark   = $('header-wordmark');
const reconnectOverlay = $('reconnect-overlay');
const mobileToolbar    = $('mobile-toolbar');
const mobileInput      = $('mobile-input');
const ctrlBtn          = $('tb-ctrl');
const mkdirBtn         = $('mkdir-btn');
const cloneBtn         = $('clone-btn');
const fontDecBtn       = $('font-dec');
const fontIncBtn       = $('font-inc');
const runnerToggleEl   = document.querySelector('.runner-toggle');

// ── xterm.js ───────────────────────────────────────────────────────────────────
const fitAddon = new FitAddon.FitAddon();
const webLinks = new WebLinksAddon.WebLinksAddon();

const term = new Terminal({
  fontFamily:       '"JetBrains Mono", "Fira Code", monospace',
  fontSize:         loadFontSize(),
  lineHeight:       1.0,
  customGlyphs:     true,
  scrollback:       5000,
  scrollSensitivity: 5,
  allowProposedApi: true,
  theme: {
    background:          '#111111',
    foreground:          '#EEEEEE',
    cursor:              '#D97757',
    cursorAccent:        '#111111',
    selectionBackground: 'rgba(217,119,87,0.30)',
    black:        '#1A1A1A', red:           '#E5484D',
    green:        '#30A46C', yellow:        '#F76B15',
    blue:         '#4D9EFF', magenta:       '#A06BDB',
    cyan:         '#00B4D8', white:         '#CCCCCC',
    brightBlack:  '#555555', brightRed:     '#FF6369',
    brightGreen:  '#4ADE80', brightYellow:  '#FFB224',
    brightBlue:   '#74B3FF', brightMagenta: '#C084FC',
    brightCyan:   '#22D3EE', brightWhite:   '#FFFFFF',
  },
});

term.loadAddon(fitAddon);
term.loadAddon(webLinks);
term.open($('terminal-container'));
term.loadAddon(new WebglAddon.WebglAddon());

function applyFontSize(size) {
  const s = Math.max(FONT_SIZE_MIN, Math.min(FONT_SIZE_MAX, size));
  term.options.fontSize = s;
  localStorage.setItem(FONT_SIZE_KEY, String(s));
  requestAnimationFrame(() => doFit());
  fontDecBtn.disabled = s <= FONT_SIZE_MIN;
  fontIncBtn.disabled = s >= FONT_SIZE_MAX;
}

applyFontSize(loadFontSize());

term.onData(data => {
  if (state.ws && state.ws.readyState === WebSocket.OPEN) state.ws.send(data);
});

// ── Layout / fit ───────────────────────────────────────────────────────────────
const PILL_H   = 52;
const PILL_GAP = 10;

let resizeTimer;

function doFit() {
  try {
    fitAddon.fit();
    if (state.ws && state.ws.readyState === WebSocket.OPEN) {
      state.ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
    }
  } catch (_) {}
}

function updateLayout() {
  const vv = window.visualViewport;
  if (!vv) { doFit(); return; }

  const keyboardH = Math.max(0, window.innerHeight - (vv.offsetTop + vv.height));

  if (state.isMobile && state.sessionActive) {
    const pillBottom = keyboardH + PILL_GAP;
    mobileToolbar.style.bottom = pillBottom + 'px';

    const pillarH = PILL_H + pillBottom;
    terminalWrap.style.paddingBottom = pillarH + 'px';
  }

  doFit();
}

window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(updateLayout, 80);
});

if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updateLayout, 80);
  });
  window.visualViewport.addEventListener('scroll', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updateLayout, 80);
  });
}

// ── View switching ─────────────────────────────────────────────────────────────
function showLaunch() {
  launchScreen.classList.remove('hidden');
  terminalView.classList.add('hidden');
  mobileToolbar.style.display = 'none';
  document.body.classList.remove('mobile-show');
  terminalWrap.style.paddingBottom = '';
  // Restore mkdir/clone buttons only if in remote tab
  if (state.activeTab === 'remote') {
    mkdirBtn.style.display = '';
    cloneBtn.style.display = '';
  }
}

function showTerminal() {
  launchScreen.classList.add('hidden');
  terminalView.classList.remove('hidden');
  mkdirBtn.style.display = 'none';
  cloneBtn.style.display = 'none';
  if (state.isMobile) {
    document.body.classList.add('mobile-show');
    mobileToolbar.style.display = '';
  }
  requestAnimationFrame(() => { updateLayout(); term.scrollToBottom(); });
}

// ── Reconnect overlay ──────────────────────────────────────────────────────────
function showReconnectOverlay() { reconnectOverlay.classList.add('visible'); }
function hideReconnectOverlay() {
  reconnectOverlay.classList.remove('visible');
  clearTimeout(state.reconnectOverlayTimer);
  state.reconnectOverlayTimer = null;
}

// ── WebSocket ──────────────────────────────────────────────────────────────────

function forceReconnect() {
  clearTimeout(state.reconnectTimer);
  clearTimeout(state.reconnectOverlayTimer);
  state.reconnectOverlayTimer = null;
  state.reconnectAttempt = 0;

  if (state.ws) {
    const old = state.ws;
    state.ws = null;
    old.onopen = old.onmessage = old.onclose = old.onerror = null;
    try { old.close(); } catch (_) {}
  }

  showReconnectOverlay();
  state.reconnectTimer = setTimeout(connect, 150);
}

async function connect() {
  if (state.hasConnectedOnce) {
    try {
      await fetch(`/api/session?_=${Date.now()}`, { cache: 'no-store' });
      return location.reload();
    } catch (_) {
      scheduleReconnect();
      return;
    }
  }

  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(`${proto}//${location.host}/?_=${Date.now()}`);
  state.ws = ws;
  ws.binaryType = 'arraybuffer';

  const connectTimeout = setTimeout(() => {
    if (state.ws !== ws) return;
    try { ws.close(); } catch (_) {}
  }, 3000);

  ws.addEventListener('open', () => {
    clearTimeout(connectTimeout);
    if (state.ws !== ws) return;
    state.wsConnected = true;
    state.hasConnectedOnce = true;
    state.reconnectAttempt = 0;
    hideReconnectOverlay();
    term.reset();
  });

  ws.addEventListener('message', evt => {
    if (state.ws !== ws) return;
    if (evt.data instanceof ArrayBuffer) {
      term.write(new Uint8Array(evt.data));
      return;
    }
    const raw = evt.data;
    let msg;
    try { msg = JSON.parse(raw); } catch (_) { term.write(raw); return; }

    if (msg.type === 'state') {
      state.sessionActive = msg.active;
      if (msg.active) {
        updateHeaderForSession(msg.sessionType, msg.sessionName, msg.cli);
        showTerminal();
      } else {
        resetHeader();
        showLaunch();
        term.clear();
        resetKillBtn();
        if (state.activeTab === 'tmux') {
          state.selectedSession = null;
          startBtn.disabled = true;
          startBtn.textContent = 'RESUME SESSION';
          loadSessions();
        } else {
          startBtn.disabled = false;
          startBtn.textContent = 'START SESSION';
        }
      }
    }
  });

  ws.addEventListener('close', () => {
    clearTimeout(connectTimeout);
    if (state.ws !== ws) return;
    state.wsConnected = false;
    scheduleReconnect();
    if (!state.reconnectOverlayTimer) {
      state.reconnectOverlayTimer = setTimeout(showReconnectOverlay, 1000);
    }
  });

  ws.addEventListener('error', () => {
    clearTimeout(connectTimeout);
    if (state.ws !== ws) return;
    ws.close();
  });
}

function scheduleReconnect() {
  const delays = [500, 1000, 2000, 4000, 10000];
  const delay = delays[Math.min(state.reconnectAttempt, delays.length - 1)];
  state.reconnectAttempt++;
  clearTimeout(state.reconnectTimer);
  if (document.visibilityState === 'hidden') return;
  state.reconnectTimer = setTimeout(connect, delay);
}

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState !== 'visible') return;
  forceReconnect();
});

window.addEventListener('pageshow', e => {
  if (e.persisted) forceReconnect();
});

window.addEventListener('focus', () => {
  if (!state.wsConnected) forceReconnect();
});

setInterval(() => {
  if (document.visibilityState !== 'visible') return;
  if (state.wsConnected && state.ws && state.ws.readyState === WebSocket.OPEN) return;
  if (state.reconnectTimer) return;
  forceReconnect();
}, 3000);

// ── Header logos ───────────────────────────────────────────────────────────────
const CLAUDE_LOGO_SVG = `<svg width="22" height="22"><use href="/icons.svg#icon-claude"/></svg>`;
const GEMINI_LOGO_SVG = `<svg width="22" height="22"><use href="/icons.svg#icon-gemini"/></svg>`;

function setHeaderLogo(cli) {
  if (cli === 'gemini') headerWordmark.innerHTML = GEMINI_LOGO_SVG;
  else headerWordmark.innerHTML = CLAUDE_LOGO_SVG;
}

// ── Header state ───────────────────────────────────────────────────────────────
function setGeminiMode(on) {
  terminalView.classList.toggle('gemini-mode', on);
}

function updateHeaderForSession(sessionType, sessionName, cli) {
  if (sessionType === 'custom') {
    if (/claude/i.test(sessionName)) { setHeaderLogo('claude'); setGeminiMode(false); }
    else if (/gemini/i.test(sessionName)) { setHeaderLogo('gemini'); setGeminiMode(true); }
    else { headerWordmark.textContent = sessionName || 'tmux'; setGeminiMode(false); }
  } else {
    setHeaderLogo(cli);
    setGeminiMode(cli === 'gemini');
  }
  detachBtn.style.display = '';
}

function resetHeader() {
  if (state.selectedCli === 'tmux') {
    headerWordmark.textContent = 'tmux';
  } else {
    setHeaderLogo(state.selectedCli || 'claude');
  }
  setGeminiMode(false);
  detachBtn.style.display = 'none';
}

// ── Tab Switcher ───────────────────────────────────────────────────────────────
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.activeTab = btn.dataset.tab;

    if (state.activeTab === 'tmux') {
      state.selectedCli = 'tmux';
      pathRow.style.display = 'none';
      runnerToggleEl.style.display = 'none';
      mkdirBtn.style.display = 'none';
      cloneBtn.style.display = 'none';
      startBtn.disabled = true;
      startBtn.textContent = 'RESUME SESSION';
      loadSessions();
    } else {
      // Restore runner selection
      const activeRunner = document.querySelector('.runner-btn.active');
      state.selectedCli = activeRunner ? activeRunner.dataset.cli : 'claude';
      pathRow.style.display = '';
      runnerToggleEl.style.display = '';
      mkdirBtn.style.display = '';
      cloneBtn.style.display = '';
      startBtn.disabled = false;
      startBtn.textContent = 'START SESSION';
      browse(state.browsePath || '');
    }
  });
});

// ── CLI Runner Toggle (Claude / Gemini) ────────────────────────────────────────
document.querySelectorAll('.runner-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.runner-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.selectedCli = btn.dataset.cli;
  });
});

// ── Session List (tmux mode) ────────────────────────────────────────────────────
async function loadSessions() {
  state.selectedSession = null;
  startBtn.disabled = true;
  startBtn.textContent = 'RESUME SESSION';

  browserList.innerHTML = '<div class="browser-loading"><span class="browser-spinner"></span> Loading…</div>';
  let data;
  try {
    const resp = await fetch('/api/tmux-sessions');
    data = await resp.json();
  } catch (err) {
    browserList.innerHTML = `<div class="browser-error">Network error: ${err.message}</div>`;
    return;
  }

  if (!data.sessions || data.sessions.length === 0) {
    browserList.innerHTML = '<div class="sessions-empty">No tmux sessions running</div>';
    return;
  }

  const frag = document.createDocumentFragment();
  for (const session of data.sessions) {
    const card = document.createElement('button');
    card.className = 'session-card';
    card.innerHTML = `
      <div class="session-card-left">
        <div class="session-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>
          </svg>
        </div>
        <div class="session-info">
          <span class="session-card-name">${session.name}</span>
          <span class="session-card-meta">${session.windows} window${session.windows !== 1 ? 's' : ''}</span>
        </div>
      </div>
    `;
    card.addEventListener('click', () => {
      document.querySelectorAll('.session-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      state.selectedSession = session.name;
      startBtn.disabled = false;
    });
    frag.appendChild(card);
  }
  browserList.innerHTML = '';
  browserList.appendChild(frag);
}

// ── Directory Browser ──────────────────────────────────────────────────────────
async function browse(dirPath) {
  mkdirBtn.style.display = '';
  browserList.innerHTML = '<div class="browser-loading"><span class="browser-spinner"></span> Loading…</div>';
  let data;
  try {
    const resp = await fetch(`/api/browse?path=${encodeURIComponent(dirPath)}`);
    data = await resp.json();
  } catch (err) {
    browserList.innerHTML = `<div class="browser-error">Network error: ${err.message}</div>`;
    return;
  }
  if (data.error) {
    browserList.innerHTML = `<div class="browser-error">${data.error}</div>`;
    if (data.path) { state.browsePath = data.path; state.browseRoot = data.browseRoot || null; renderBreadcrumb(data.path, state.browseRoot); }
    return;
  }
  state.browsePath = data.path;
  state.browseRoot = data.browseRoot || null;
  renderBreadcrumb(data.path, state.browseRoot);

  const frag = document.createDocumentFragment();
  if (data.parent) frag.appendChild(makeEntryRow('parent', null, '..', data.parent, null));
  for (const e of data.entries) {
    const full = data.path.replace(/\/$/, '') + '/' + e.name;
    frag.appendChild(makeEntryRow(e.type, null, e.name, e.type === 'dir' ? full : null, e.mtime));
  }
  if (!data.entries.length && !data.parent) {
    const msg = document.createElement('div');
    msg.className = 'browser-loading';
    msg.textContent = 'Empty directory';
    frag.appendChild(msg);
  }
  browserList.innerHTML = '';
  browserList.appendChild(frag);
}

function fmtMtime(ms) {
  if (!ms) return '';
  const d = new Date(ms);
  const now = new Date();
  const diffDays = (now - d) / 86400000;
  if (diffDays < 1 && now.getDate() === d.getDate()) {
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  if (diffDays < 365) {
    return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
  }
  return d.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
}

const ICON_PARENT = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="14 9 9 4 4 9"/><path d="M20 20h-7a4 4 0 0 1-4-4V4"/></svg>`;
const ICON_FOLDER = `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>`;
const ICON_FILE   = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`;

function makeEntryRow(type, _icon, name, targetPath, mtime) {
  const row = document.createElement('button');
  row.className = `browser-entry ${type}`;

  const left = document.createElement('div');
  left.className = 'entry-left';

  const iconWrap = document.createElement('div');
  iconWrap.className = 'entry-icon';
  iconWrap.innerHTML = type === 'parent' ? ICON_PARENT : type === 'dir' ? ICON_FOLDER : ICON_FILE;

  const textCol = document.createElement('div');
  textCol.className = 'entry-text';

  const nm = document.createElement('span');
  nm.className = 'entry-name';
  nm.textContent = name;
  textCol.appendChild(nm);

  if (mtime) {
    const meta = document.createElement('span');
    meta.className = 'entry-meta';
    meta.textContent = fmtMtime(mtime);
    textCol.appendChild(meta);
  }

  left.appendChild(iconWrap);
  left.appendChild(textCol);
  row.appendChild(left);

  if (targetPath) {
    row.addEventListener('click', () => browse(targetPath));
  } else {
    row.disabled = true;
  }
  return row;
}

function renderBreadcrumb(fullPath, browseRoot) {
  const lock = browseRoot ? '🔒 ' : '';
  pathDisplay.textContent = lock + '/' + fullPath.split('/').filter(Boolean).join('/');
}

// ── Start Session ──────────────────────────────────────────────────────────────
startBtn.addEventListener('click', async () => {
  if (state.activeTab === 'tmux') {
    if (!state.selectedSession) return;
    startBtn.disabled = true;
    startBtn.textContent = 'ATTACHING…';
    try {
      const resp = await fetch('/api/session/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionName: state.selectedSession }),
      });
      const data = await resp.json();
      if (!resp.ok) {
        alert(data.error || 'Failed to attach to session');
        startBtn.disabled = false;
        startBtn.textContent = 'RESUME SESSION';
      }
    } catch (err) {
      alert('Network error: ' + err.message);
      startBtn.disabled = false;
      startBtn.textContent = 'RESUME SESSION';
    }
  } else {
    if (!state.browsePath) return;
    startBtn.disabled = true;
    startBtn.textContent = 'STARTING…';
    try {
      const resp = await fetch('/api/session/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cwd: state.browsePath, cli: state.selectedCli }),
      });
      const data = await resp.json();
      if (!resp.ok) {
        alert(data.error || 'Failed to start session');
        startBtn.disabled = false;
        startBtn.textContent = 'START SESSION';
      }
    } catch (err) {
      alert('Network error: ' + err.message);
      startBtn.disabled = false;
      startBtn.textContent = 'START SESSION';
    }
  }
});

// ── Header Menu ────────────────────────────────────────────────────────────────
const menuBtn        = $('menu-btn');
const headerMenu     = $('header-menu');
const headerMenuScrim = $('header-menu-scrim');

function openHeaderMenu() {
  headerMenu.classList.add('open');
  headerMenuScrim.classList.add('open');
}

function closeHeaderMenu() {
  headerMenu.classList.remove('open');
  headerMenuScrim.classList.remove('open');
  // Reset kill confirm if menu closes
  if (state.killConfirmPending) resetKillBtn();
}

menuBtn.addEventListener('click', () => {
  if (headerMenu.classList.contains('open')) closeHeaderMenu();
  else openHeaderMenu();
});

headerMenuScrim.addEventListener('click', closeHeaderMenu);

// Font buttons close menu on touch (mobile) so user can see result
fontDecBtn.addEventListener('click', () => applyFontSize(term.options.fontSize - 1));
fontIncBtn.addEventListener('click', () => applyFontSize(term.options.fontSize + 1));

// ── Detach Session ─────────────────────────────────────────────────────────────
detachBtn.addEventListener('click', async () => {
  closeHeaderMenu();
  try { await fetch('/api/session/detach', { method: 'POST' }); } catch (_) {}
});

// ── Kill Session ───────────────────────────────────────────────────────────────
const killBtnLabel = $('kill-btn-label');

function resetKillBtn() {
  state.killConfirmPending = false;
  clearTimeout(state.killConfirmTimer);
  killBtnLabel.textContent = 'End Session';
  killBtn.classList.remove('confirm');
}
killBtn.addEventListener('click', async () => {
  if (!state.killConfirmPending) {
    state.killConfirmPending = true;
    killBtnLabel.textContent = 'Confirm?';
    killBtn.classList.add('confirm');
    state.killConfirmTimer = setTimeout(resetKillBtn, 3000);
  } else {
    resetKillBtn();
    closeHeaderMenu();
    try { await fetch('/api/session/kill', { method: 'POST' }); } catch (_) {}
  }
});

// ── Mobile Toolbar ─────────────────────────────────────────────────────────────
function sendKey(key) {
  if (state.ws && state.ws.readyState === WebSocket.OPEN) state.ws.send(key);
  if (navigator.vibrate) navigator.vibrate(8);
}

document.querySelectorAll('.tb-btn[data-key]').forEach(btn => {
  btn.addEventListener('pointerdown', e => {
    e.preventDefault();
    sendKey(btn.dataset.key);
  });
});

ctrlBtn.addEventListener('pointerdown', e => {
  e.preventDefault();
  state.ctrlMode = !state.ctrlMode;
  ctrlBtn.classList.toggle('ctrl-active', state.ctrlMode);
  if (navigator.vibrate) navigator.vibrate(8);
  if (state.isMobile) { mobileInput.setAttribute('inputmode', 'text'); mobileInput.focus(); }
});

function clearCtrl() {
  state.ctrlMode = false;
  ctrlBtn.classList.remove('ctrl-active');
}

// ── Compose Overlay ───────────────────────────────────────────────────────────
const composeOverlay  = $('compose-overlay');
const composeScrim    = $('compose-scrim');
const composeTextarea = $('compose-textarea');
const composeSend     = $('compose-send');
const composeCancel   = $('compose-cancel');
const tbCompose       = $('tb-compose');

function autoResizeTextarea() {
  const vv = window.visualViewport;
  const availH = (vv ? vv.height : window.innerHeight) - 60;
  composeTextarea.style.height = 'auto';
  const natural = composeTextarea.scrollHeight;
  if (natural >= availH) {
    composeTextarea.style.height = availH + 'px';
    composeTextarea.style.overflowY = 'auto';
  } else {
    composeTextarea.style.height = natural + 'px';
    composeTextarea.style.overflowY = 'hidden';
  }
}

function updateComposeSize() {
  const vv = window.visualViewport;
  if (!vv) return;
  const keyboardH = Math.max(0, window.innerHeight - (vv.offsetTop + vv.height));
  composeOverlay.style.bottom = keyboardH + 'px';
  autoResizeTextarea();
}

function openCompose() {
  updateComposeSize();
  composeOverlay.classList.add('open');
  composeScrim.classList.add('visible');
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', updateComposeSize);
    window.visualViewport.addEventListener('scroll', updateComposeSize);
  }
  setTimeout(() => { composeTextarea.focus(); autoResizeTextarea(); }, 50);
}

function closeCompose() {
  if (window.visualViewport) {
    window.visualViewport.removeEventListener('resize', updateComposeSize);
    window.visualViewport.removeEventListener('scroll', updateComposeSize);
  }
  composeTextarea.blur();
  composeOverlay.classList.remove('open');
  composeScrim.classList.remove('visible');
  setTimeout(() => {
    composeOverlay.style.bottom = '';
    composeTextarea.style.height = '';
    composeTextarea.style.overflowY = '';
  }, 260);
}

function submitCompose() {
  const text = composeTextarea.value.trimEnd();
  if (text && state.ws && state.ws.readyState === WebSocket.OPEN) {
    state.ws.send(text);
    setTimeout(() => {
      if (state.ws && state.ws.readyState === WebSocket.OPEN) state.ws.send('\r');
    }, 30);
  }
  composeTextarea.value = '';
  closeCompose();
}

tbCompose.addEventListener('pointerdown', e => {
  e.preventDefault();
  if (navigator.vibrate) navigator.vibrate(8);
  openCompose();
});

composeCancel.addEventListener('click', closeCompose);
composeScrim.addEventListener('click', closeCompose);

composeSend.addEventListener('pointerdown', e => {
  e.preventDefault();
  submitCompose();
});

composeTextarea.addEventListener('input', autoResizeTextarea);

composeTextarea.addEventListener('keydown', e => {
  if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault();
    submitCompose();
  }
});

// ── Mobile keyboard capture ────────────────────────────────────────────────────

if (state.isMobile) {
  $('terminal-container').addEventListener('click', () => {
    mobileInput.setAttribute('inputmode', 'text');
    mobileInput.focus();
  });

  mobileInput.addEventListener('input', () => {
    // Strip any typographic quotes iOS may have inserted around digits.
    const val = mobileInput.value.replace(/[\u2018\u2019\u201C\u201D]/g, '');
    mobileInput.value = '';
    if (!val) return;
    if (state.ctrlMode) {
      const code = val[0].toLowerCase().charCodeAt(0) - 96;
      if (code >= 1 && code <= 26) sendKey(String.fromCharCode(code));
      else sendKey(val);
      clearCtrl();
    } else {
      sendKey(val);
    }
  });

  mobileInput.addEventListener('keydown', e => {
    let key = null;

    // iOS wraps digit e.key values in typographic quotes e.g. "\u201C5\u201D"
    // Strip them so length check and comparisons work correctly.
    const eKey = e.key.replace(/^[\u2018\u2019\u201C\u201D]+|[\u2018\u2019\u201C\u201D]+$/g, '');

    if (eKey === 'Backspace')        key = '\x7f';
    else if (eKey === 'Enter')       key = '\r';
    else if (eKey === 'Escape')      key = '\x1b';
    else if (eKey === 'Tab')         { key = '\t'; e.preventDefault(); }
    else if (eKey === 'ArrowUp')     key = '\x1b[A';
    else if (eKey === 'ArrowDown')   key = '\x1b[B';
    else if (eKey === 'ArrowLeft')   key = '\x1b[D';
    else if (eKey === 'ArrowRight')  key = '\x1b[C';
    else if (eKey.length === 1 && !e.metaKey) {
      // Handle all printable characters here so we don't depend on the
      // input event (unreliable for numbers on iOS "123" keyboard layout).
      if (e.ctrlKey) {
        const code = eKey.toLowerCase().charCodeAt(0) - 96;
        if (code >= 1 && code <= 26) key = String.fromCharCode(code);
      } else if (!e.altKey) {
        if (state.ctrlMode) {
          const code = eKey.toLowerCase().charCodeAt(0) - 96;
          key = (code >= 1 && code <= 26) ? String.fromCharCode(code) : eKey;
          clearCtrl();
        } else {
          key = eKey;
        }
      }
    }

    if (key) { sendKey(key); e.preventDefault(); }
  });

  mobileInput.addEventListener('blur', () => {
    mobileInput.setAttribute('inputmode', 'none');
  });
}

// ── Mkdir Modal ────────────────────────────────────────────────────────────────
const mkdirScrim     = $('mkdir-scrim');
const mkdirModal     = $('mkdir-modal');
const mkdirInput     = $('mkdir-input');
const mkdirError     = $('mkdir-error');
const mkdirCreateBtn = $('mkdir-create-btn');
const mkdirCancelBtn = $('mkdir-cancel-btn');

function openMkdir() {
  mkdirInput.value = '';
  mkdirError.textContent = '';
  mkdirCreateBtn.disabled = false;
  mkdirScrim.classList.add('visible');
  mkdirModal.classList.add('open');
  setTimeout(() => mkdirInput.focus(), 50);
}

function closeMkdir() {
  mkdirScrim.classList.remove('visible');
  mkdirModal.classList.remove('open');
  mkdirInput.blur();
}

async function submitMkdir() {
  const name = mkdirInput.value.trim();
  if (!name) return;
  if (name.includes('/')) { mkdirError.textContent = 'Name cannot contain /'; return; }

  const fullPath = state.browsePath.replace(/\/$/, '') + '/' + name;
  mkdirCreateBtn.disabled = true;
  mkdirError.textContent = '';

  try {
    const resp = await fetch('/api/mkdir', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: fullPath }),
    });
    const data = await resp.json();
    if (!resp.ok) {
      mkdirError.textContent = data.error || 'Failed to create folder';
      mkdirCreateBtn.disabled = false;
      return;
    }
    closeMkdir();
    browse(state.browsePath);
  } catch (err) {
    mkdirError.textContent = 'Network error';
    mkdirCreateBtn.disabled = false;
  }
}

mkdirBtn.addEventListener('click', openMkdir);
mkdirCancelBtn.addEventListener('click', closeMkdir);
mkdirScrim.addEventListener('click', closeMkdir);
mkdirCreateBtn.addEventListener('click', submitMkdir);
mkdirInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); submitMkdir(); }
  if (e.key === 'Escape') { e.preventDefault(); closeMkdir(); }
});

// ── Clone Modal ────────────────────────────────────────────────────────────────
const cloneScrim     = $('clone-scrim');
const cloneModal     = $('clone-modal');
const cloneUrlInput  = $('clone-url-input');
const cloneDestInput = $('clone-dest-input');
const cloneStatus    = $('clone-status');
const cloneSubmitBtn = $('clone-submit-btn');
const cloneCancelBtn = $('clone-cancel-btn');

function openClone() {
  cloneUrlInput.value = '';
  cloneDestInput.value = '';
  cloneStatus.textContent = '';
  cloneStatus.className = 'clone-status';
  cloneSubmitBtn.disabled = false;
  cloneScrim.classList.add('visible');
  cloneModal.classList.add('open');
  setTimeout(() => cloneUrlInput.focus(), 50);
}

function closeClone() {
  cloneScrim.classList.remove('visible');
  cloneModal.classList.remove('open');
  cloneUrlInput.blur();
  cloneDestInput.blur();
}

async function submitClone() {
  const url = cloneUrlInput.value.trim();
  if (!url) return;
  const dest = cloneDestInput.value.trim();

  cloneStatus.textContent = 'Cloning…';
  cloneStatus.className = 'clone-status cloning';
  cloneSubmitBtn.disabled = true;

  try {
    const resp = await fetch('/api/git-clone', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url, dest: dest || undefined, cwd: state.browsePath }),
    });
    const data = await resp.json();
    if (!resp.ok) {
      cloneStatus.textContent = data.error || 'Clone failed';
      cloneStatus.className = 'clone-status error';
      cloneSubmitBtn.disabled = false;
      return;
    }
    closeClone();
    browse(state.browsePath);
  } catch (err) {
    cloneStatus.textContent = 'Network error';
    cloneStatus.className = 'clone-status error';
    cloneSubmitBtn.disabled = false;
  }
}

cloneBtn.addEventListener('click', openClone);
cloneCancelBtn.addEventListener('click', closeClone);
cloneScrim.addEventListener('click', closeClone);
cloneSubmitBtn.addEventListener('click', submitClone);
[cloneUrlInput, cloneDestInput].forEach(inp => {
  inp.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); submitClone(); }
    if (e.key === 'Escape') { e.preventDefault(); closeClone(); }
  });
});

// ── Bootstrap ──────────────────────────────────────────────────────────────────
(async () => {
  const resp = await fetch('/api/session').catch(() => null);
  const session = resp ? await resp.json().catch(() => null) : null;
  browse((session && session.cwd) ? session.cwd : '');
  mkdirBtn.style.display = ''; // show now that we're in remote tab on launch screen
  cloneBtn.style.display = '';
})();

connect();
</script>
</body>
</html>
