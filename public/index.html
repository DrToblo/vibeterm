<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#111111">
  <title>claude</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- xterm.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/css/xterm.css">
  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0/lib/addon-fit.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0/lib/addon-web-links.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-webgl@0/lib/addon-webgl.js"></script>

  <style>
    /* â”€â”€ Variables â”€â”€ */
    :root {
      --bg-primary:    #111111;
      --bg-secondary:  #1A1A1A;
      --bg-card:       #161616;
      --border-color:  #2A2A2A;
      --text-primary:  #EEEEEE;
      --text-secondary:#666666;
      --accent:        #D97757;
      --accent-hover:  #C96442;
      --status-green:  #30A46C;
      --status-red:    #E5484D;
      --status-amber:  #F76B15;
      --font-ui:       'JetBrains Mono', 'Fira Code', monospace;
      --font-mono:     'JetBrains Mono', 'Fira Code', monospace;
      --header-h:      52px;
      --pill-h:        52px;   /* toolbar pill height */
      --pill-gap:      10px;   /* gap between pill and screen edge */
    }

    /* â”€â”€ Reset â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { background: #111111; }
    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: var(--font-ui);
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ Views â”€â”€ */
    #launch-screen, #terminal-view {
      position: fixed;
      inset: 0;
      transition: opacity 0.2s ease;
    }
    #launch-screen {
      display: flex;
      flex-direction: column;
      background: #0C0B09;
      z-index: 10;
      overflow: hidden;
    }
    #terminal-view {
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      z-index: 5;
    }
    .hidden { opacity: 0; pointer-events: none; }

    /* â”€â”€ CLIVE Logo â”€â”€ */
    .clive-logo {
      font-size: 10px;
      line-height: 1.2;
      pointer-events: none;
      user-select: none;
      letter-spacing: -0.05em;
      filter: drop-shadow(0 0 12px rgba(85,107,47,0.2));
    }
    .clive-logo .logo-cli { color: #556B2F; }
    .clive-logo .logo-ve  { color: #A14A36; }
    .clive-logo .flex-row { display: flex; white-space: pre; }

    /* â”€â”€ Launch Header â”€â”€ */
    #launch-header {
      flex-shrink: 0;
      padding: 40px 24px 16px;
      background: rgba(10,10,10,0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      gap: 24px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #path-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    #path-display {
      font-size: 16px;
      color: #F0EDE8;
      font-family: var(--font-mono);
    }
    #mkdir-btn {
      background: none;
      border: none;
      font-family: var(--font-mono);
      font-size: 16px;
      font-weight: 700;
      color: #F0EDE8;
      cursor: pointer;
      transition: color 0.15s;
      letter-spacing: -0.03em;
      -webkit-tap-highlight-color: transparent;
    }
    #mkdir-btn:hover { color: #FFFFFF; }

    /* â”€â”€ Directory Browser â”€â”€ */
    #browser-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 16px 140px;
    }
    #browser-list::-webkit-scrollbar { display: none; }

    .browser-entry {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 12px;
      cursor: pointer;
      font-family: var(--font-mono);
      color: var(--text-primary);
      transition: background 0.1s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      background: none;
      border: none;
      border-radius: 8px;
      width: 100%;
      text-align: left;
    }
    .browser-entry:active { background: rgba(255,255,255,0.05); }
    .browser-entry.file { cursor: default; }
    .entry-left { display: flex; align-items: center; gap: 16px; }
    .entry-icon {
      color: #F0EDE8;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      transition: color 0.15s;
    }
    .entry-name {
      font-size: 16px;
      color: #F0EDE8;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .browser-entry.file .entry-name { color: #F0EDE8; }
    .entry-meta {
      font-size: 11px;
      color: rgba(102,102,102,0.4);
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.04em;
      flex-shrink: 0;
    }

    .browser-loading, .browser-error {
      padding: 20px 12px;
      text-align: center;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .browser-error { color: var(--status-red); }
    .browser-spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid #2A2A2A;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    /* â”€â”€ Bottom Launch Bar â”€â”€ */
    #bottom-bar {
      position: fixed;
      bottom: 32px;
      left: 0;
      width: 100%;
      padding: 0 24px;
      display: flex;
      justify-content: center;
      z-index: 20;
    }
    #bottom-bar-inner {
      background: rgba(18,18,18,0.95);
      border: 1px solid rgba(255,255,255,0.1);
      padding: 6px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.8);
      width: 100%;
      max-width: 340px;
    }
    .runner-toggle {
      display: flex;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 999px;
      padding: 4px;
      gap: 4px;
      flex-shrink: 0;
    }
    .runner-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0.3;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      color: #ffffff;
    }
    .runner-btn:hover { opacity: 0.6; }
    .runner-btn.active {
      background: #A14A36;
      color: #ffffff;
      opacity: 1;
      box-shadow: 0 0 15px rgba(161,74,54,0.4);
    }
    #start-btn {
      flex: 1;
      height: 48px;
      background: #A14A36;
      color: #ffffff;
      border: none;
      border-radius: 999px;
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s, transform 0.08s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      letter-spacing: 0.04em;
      box-shadow: 0 0 20px rgba(161,74,54,0.2);
    }
    #start-btn:hover { background: #8C3F2E; }
    #start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #start-btn:active:not(:disabled) { transform: scale(0.99); }

    /* â”€â”€ Mkdir Modal â”€â”€ */
    #mkdir-scrim {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 70;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    #mkdir-scrim.visible { opacity: 1; pointer-events: auto; }

    #mkdir-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -48%) scale(0.96);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 71;
      background: #131210;
      border: 1px solid #2A2826;
      border-radius: 16px;
      padding: 24px;
      width: calc(100% - 48px);
      max-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #mkdir-modal.open {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    #mkdir-modal-title {
      font-size: 13px;
      font-weight: 700;
      color: #7A7570;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    #mkdir-input {
      width: 100%;
      background: #0C0B09;
      border: 1px solid #2A2826;
      border-radius: 8px;
      padding: 12px 14px;
      font-family: var(--font-mono);
      font-size: 15px;
      color: #F0EDE8;
      outline: none;
      transition: border-color 0.15s;
    }
    #mkdir-input:focus { border-color: #556B2F; }
    #mkdir-input::placeholder { color: #3A3835; }
    .mkdir-actions {
      display: flex;
      gap: 8px;
    }
    .mkdir-actions button {
      flex: 1;
      height: 44px;
      border-radius: 999px;
      border: none;
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.08s;
      -webkit-tap-highlight-color: transparent;
    }
    .mkdir-actions button:active { transform: scale(0.97); }
    #mkdir-cancel-btn {
      background: #1E1C1A;
      color: #7A7570;
    }
    #mkdir-cancel-btn:hover { color: #F0EDE8; }
    #mkdir-create-btn {
      background: #A14A36;
      color: #F0EDE8;
    }
    #mkdir-create-btn:hover { background: #8C3F2E; }
    #mkdir-create-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    #mkdir-error {
      font-size: 12px;
      color: var(--status-red);
      text-align: center;
      min-height: 16px;
    }

    /* â”€â”€ Header â”€â”€ */
    #header {
      height: var(--header-h);
      min-height: var(--header-h);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
      z-index: 20;
    }
    .header-wordmark {
      font-family: var(--font-ui);
      font-size: 17px;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: -0.2px;
    }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      background: var(--bg-secondary);
      font-size: 12.5px;
      font-weight: 500;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
    .status-dot.green { background: var(--status-green); }
    .status-dot.amber { background: var(--status-amber); animation: pulse 1.2s ease-in-out infinite; }
    .status-dot.red   { background: var(--status-red); }

    .kill-btn {
      background: none;
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 5px 14px;
      font-family: var(--font-ui);
      font-size: 12.5px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .kill-btn:hover { border-color: var(--status-red); color: var(--status-red); }
    .kill-btn.confirm { background: var(--status-red); color: #fff; border-color: var(--status-red); }

    /* â”€â”€ Terminal Container â”€â”€ */
    #terminal-wrap {
      flex: 1;
      overflow: hidden;
      position: relative;
      padding: 8px;
    }
    #terminal-container {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.4);
      background: #111111;
    }
    @media (max-width: 767px) {
      #terminal-wrap { padding: 0; }
      #terminal-container { border-radius: 0; box-shadow: none; }
    }
    /* xterm overrides */
    .xterm { height: 100%; }
    .xterm-screen { margin: 0 auto; }   /* center canvas â€” xterm leaves fractional px on one side */
    .xterm-viewport { overflow-y: auto !important; }
    .xterm-viewport::-webkit-scrollbar { width: 6px; }
    .xterm-viewport::-webkit-scrollbar-track { background: transparent; }
    .xterm-viewport::-webkit-scrollbar-thumb { background: rgba(150,150,150,0.2); border-radius: 3px; }

    /* â”€â”€ Mobile Toolbar Row â”€â”€ */
    /* Floats above keyboard, not part of flex flow */
    #mobile-toolbar {
      display: none;
      position: fixed;
      bottom: var(--pill-gap);
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 24px);
      max-width: 560px;
      align-items: center;
      gap: 8px;
      z-index: 40;
    }
    .mobile-show #mobile-toolbar { display: flex; }

    /* â”€â”€ Toolbar Pill â”€â”€ */
    #toolbar-pill {
      flex: 1;
      height: var(--pill-h);
      background: rgba(22, 22, 22, 0.97);
      border: 1px solid var(--border-color);
      border-radius: calc(var(--pill-h) / 2);
      box-shadow: 0 4px 24px rgba(0,0,0,0.13), 0 1px 4px rgba(0,0,0,0.07);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow: hidden;
      display: flex;
      align-items: center;
      padding: 0 6px;
      gap: 0;
    }

    /* â”€â”€ Compose Circle Button â”€â”€ */
    #tb-compose {
      flex-shrink: 0;
      width: var(--pill-h);
      height: var(--pill-h);
      border-radius: 50%;
      background: rgba(22, 22, 22, 0.97);
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 24px rgba(0,0,0,0.13), 0 1px 4px rgba(0,0,0,0.07);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      cursor: pointer;
      transition: color 0.08s, transform 0.08s, background 0.08s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }
    #tb-compose:active {
      background: var(--accent);
      color: #fff;
      transform: scale(0.88);
    }

    .tb-btn {
      flex: 1;
      min-width: 0;
      height: 40px;
      padding: 0;
      background: transparent;
      border: none;
      font-family: var(--font-mono);
      font-size: 13px;
      color: #ffffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      transition: color 0.08s, transform 0.08s, background 0.08s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      border-radius: 999px;
    }
    .tb-btn:active {
      background: var(--accent);
      color: #fff;
      transform: scale(0.88);
    }
    /* Sticky Ctrl active state */
    .tb-btn.ctrl-active {
      color: var(--accent);
    }
    .tb-sep {
      flex-shrink: 0;
      width: 1px;
      height: 18px;
      background: var(--border-color);
      margin: 0 2px;
    }

    /* â”€â”€ Reconnect Overlay â”€â”€ */
    #reconnect-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: rgba(17,17,17,0.88);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #reconnect-overlay.visible { opacity: 1; pointer-events: auto; }
    .reconnect-spinner {
      width: 28px; height: 28px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .reconnect-text { font-size: 14px; color: var(--text-secondary); font-weight: 500; }

    /* â”€â”€ Hidden mobile input â”€â”€ */
    #mobile-input {
      position: fixed;
      top: -9999px; left: -9999px;
      opacity: 0;
      width: 1px; height: 1px;
      resize: none;
      border: none;
      outline: none;
    }

    /* â”€â”€ Compose Scrim â”€â”€ */
    #compose-scrim {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 59;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }
    #compose-scrim.visible { opacity: 1; pointer-events: auto; }

    /* â”€â”€ Compose Overlay â€” bottom sheet â”€â”€ */
    #compose-overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 60;
      display: flex;
      flex-direction: column;
      background: rgba(22, 22, 22, 0.92);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-top: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 20px 20px 0 0;
      transform: translateY(100%);
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #compose-overlay.open { transform: translateY(0); }

    #compose-body {
      padding: 14px 16px;
    }
    #compose-box {
      position: relative;
    }
    #compose-textarea {
      display: block;
      width: 100%;
      resize: none;
      border: 1.5px solid #444444;
      border-radius: 24px;
      padding: 14px 52px 52px 16px;
      font-family: var(--font-mono);
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--bg-secondary);
      outline: none;
      min-height: calc(33vh - 60px);
      overflow-y: hidden;
    }
    #compose-textarea::placeholder { color: var(--text-secondary); }

    #compose-cancel {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255,255,255,0.08);
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: background 0.12s, color 0.12s;
    }
    #compose-cancel:hover { background: rgba(255,255,255,0.14); color: var(--text-primary); }

    #compose-send {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: background 0.15s, transform 0.08s;
    }
    #compose-send:hover { background: var(--accent-hover); }
    #compose-send:active { transform: scale(0.92); }

    /* â”€â”€ Animations â”€â”€ */
    @keyframes spin  { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LAUNCH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="launch-screen">

  <div id="launch-header">
    <pre class="clive-logo"><div class="flex-row"><span class="logo-cli"> â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—</span><span class="logo-ve">â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—</span></div><div class="flex-row"><span class="logo-cli">â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘</span><span class="logo-ve">â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•</span></div><div class="flex-row"><span class="logo-cli">â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘</span><span class="logo-ve">â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  </span></div><div class="flex-row"><span class="logo-cli">â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘</span><span class="logo-ve">â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•  </span></div><div class="flex-row"><span class="logo-cli">â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘</span><span class="logo-ve"> â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—</span></div><div class="flex-row"><span class="logo-cli"> â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•</span><span class="logo-ve">  â•šâ•â•â•â•  â•šâ•â•â•â•â•â•â•</span></div></pre>

    <div id="path-row">
      <span id="path-display">/</span>
      <button id="mkdir-btn">mkdir</button>
    </div>
  </div>

  <div id="browser-list">
    <div class="browser-loading"><span class="browser-spinner"></span> Loadingâ€¦</div>
  </div>

  <div id="bottom-bar">
    <div id="bottom-bar-inner">
      <div class="runner-toggle">
        <button class="runner-btn active" data-cli="claude">
          <svg fill="none" height="20" viewBox="0 -.01 39.5 39.53" width="20" xmlns="http://www.w3.org/2000/svg"><path d="m7.75 26.27 7.77-4.36.13-.38-.13-.21h-.38l-1.3-.08-4.44-.12-3.85-.16-3.73-.2-.94-.2-.88-1.16.09-.58.79-.53 1.13.1 2.5.17 3.75.26 2.72.16 4.03.42h.64l.09-.26-.22-.16-.17-.16-3.88-2.63-4.2-2.78-2.2-1.6-1.19-.81-.6-.76-.26-1.66 1.08-1.19 1.45.1.37.1 1.47 1.13 3.14 2.43 4.1 3.02.6.5.24-.17.03-.12-.27-.45-2.23-4.03-2.38-4.1-1.06-1.7-.28-1.02c-.1-.42-.17-.77-.17-1.2l1.23-1.67.68-.22 1.64.22.69.6 1.02 2.33 1.65 3.67 2.56 4.99.75 1.48.4 1.37.15.42h.26v-.24l.21-2.81.39-3.45.38-4.44.13-1.25.62-1.5 1.23-.81.96.46.79 1.13-.11.73-.47 3.05-.92 4.78-.6 3.2h.35l.4-.4 1.62-2.15 2.72-3.4 1.2-1.35 1.4-1.49.9-.71h1.7l1.25 1.86-.56 1.92-1.75 2.22-1.45 1.88-2.08 2.8-1.3 2.24.12.18.31-.03 4.7-1 2.54-.46 3.03-.52 1.37.64.15.65-.54 1.33-3.24.8-3.8.76-5.66 1.34-.07.05.08.1 2.55.24 1.09.06h2.67l4.97.37 1.3.86.78 1.05-.13.8-2 1.02-2.7-.64-6.3-1.5-2.16-.54h-.3v.18l1.8 1.76 3.3 2.98 4.13 3.84.21.95-.53.75-.56-.08-3.63-2.73-1.4-1.23-3.17-2.67h-.21v.28l.73 1.07 3.86 5.8.2 1.78-.28.58-1 .35-1.1-.2-2.26-3.17-2.33-3.57-1.88-3.2-.23.13-1.11 11.95-.52.61-1.2.46-1-.76-.53-1.23.53-2.43.64-3.17.52-2.52.47-3.13.28-1.04-.02-.07-.23.03-2.36 3.24-3.59 4.85-2.84 3.04-.68.27-1.18-.61.11-1.09.66-.97 3.93-5 2.37-3.1 1.53-1.79-.01-.26h-.09l-10.44 6.78-1.86.24-.8-.75.1-1.23.38-.4 3.14-2.16z" fill="currentColor"/></svg>
        </button>
        <button class="runner-btn" data-cli="gemini">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M11.9961 24C12.1818 17.5091 17.2917 12.1818 24 11.9961C17.2917 11.8105 12.1818 6.49132 11.9961 0C11.8105 6.49132 6.69229 11.8105 0 11.9961C6.69229 12.1818 11.8105 17.5091 11.9961 24Z"/></svg>
        </button>
      </div>
      <button id="start-btn">INITIALIZE</button>
    </div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MKDIR MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mkdir-scrim"></div>
<div id="mkdir-modal">
  <div id="mkdir-modal-title">New Folder</div>
  <input id="mkdir-input" type="text" placeholder="folder-name"
    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <div id="mkdir-error"></div>
  <div class="mkdir-actions">
    <button id="mkdir-cancel-btn">Cancel</button>
    <button id="mkdir-create-btn">Create</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TERMINAL VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="terminal-view" class="hidden">

  <header id="header">
    <div class="header-wordmark">claude</div>
    <div class="header-right">
      <div class="status-pill">
        <div class="status-dot red" id="status-dot"></div>
        <span id="status-text">Disconnected</span>
      </div>
      <button class="kill-btn" id="kill-btn">âœ• End Session</button>
    </div>
  </header>

  <div id="terminal-wrap">
    <div id="terminal-container"></div>
  </div>

</div>

<!-- Floating toolbar row (outside terminal-view, position: fixed) -->
<div id="mobile-toolbar">
  <div id="toolbar-pill">
    <button class="tb-btn" data-key="&#x1b;">Esc</button>
    <button class="tb-btn" data-key="&#x09;">Tab</button>
    <button class="tb-btn" data-key="&#x1b;[A">â–²</button>
    <button class="tb-btn" data-key="&#x1b;[B">â–¼</button>
    <button class="tb-btn" data-key="&#x1b;[D">â—€</button>
    <button class="tb-btn" data-key="&#x1b;[C">â–¶</button>
    <button class="tb-btn" data-key="&#x0d;" style="font-size:20px">â†µ</button>
    <div class="tb-sep"></div>
    <button class="tb-btn" id="tb-ctrl">Ctrl</button>
    <button class="tb-btn" data-key="&#x03;">^C</button>
  </div>
  <button id="tb-compose">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     COMPOSE SCRIM + OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="compose-scrim"></div>
<div id="compose-overlay">
  <div id="compose-body">
    <div id="compose-box">
      <textarea id="compose-textarea"
        placeholder="Type your command or messageâ€¦"
        autocomplete="off" autocorrect="off" autocapitalize="off"
        spellcheck="false"></textarea>
      <button id="compose-cancel">âœ•</button>
      <button id="compose-send">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RECONNECT OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="reconnect-overlay">
  <div class="reconnect-spinner"></div>
  <div class="reconnect-text">Reconnectingâ€¦</div>
</div>

<textarea id="mobile-input"
  autocomplete="off" autocorrect="off" autocapitalize="off"
  spellcheck="false" inputmode="none" tabindex="-1" rows="1"></textarea>

<script>
'use strict';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  browsePath: '',
  selectedCli: 'claude',
  sessionActive: false,
  wsConnected: false,
  ws: null,
  reconnectAttempt: 0,
  reconnectTimer: null,
  reconnectOverlayTimer: null,
  killConfirmTimer: null,
  killConfirmPending: false,
  ctrlMode: false,
  isMobile: ('ontouchstart' in window) || window.innerWidth < 768,
};

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
const launchScreen     = $('launch-screen');
const terminalView     = $('terminal-view');
const terminalWrap     = $('terminal-wrap');
const pathDisplay      = $('path-display');
const browserList      = $('browser-list');
const startBtn         = $('start-btn');
const statusDot        = $('status-dot');
const statusText       = $('status-text');
const killBtn          = $('kill-btn');
const reconnectOverlay = $('reconnect-overlay');
const mobileToolbar    = $('mobile-toolbar');
const mobileInput      = $('mobile-input');
const ctrlBtn          = $('tb-ctrl');

// â”€â”€ xterm.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fitAddon = new FitAddon.FitAddon();
const webLinks = new WebLinksAddon.WebLinksAddon();

const term = new Terminal({
  fontFamily:       '"JetBrains Mono", "Fira Code", monospace',
  fontSize:         window.innerWidth < 768 ? 12 : 13.5,
  lineHeight:       1.0,
  customGlyphs:     true,
  scrollback:       5000,
  scrollSensitivity: 5,
  allowProposedApi: true,
  theme: {
    background:          '#111111',
    foreground:          '#EEEEEE',
    cursor:              '#D97757',
    cursorAccent:        '#111111',
    selectionBackground: 'rgba(217,119,87,0.30)',
    black:        '#1A1A1A', red:           '#E5484D',
    green:        '#30A46C', yellow:        '#F76B15',
    blue:         '#4D9EFF', magenta:       '#A06BDB',
    cyan:         '#00B4D8', white:         '#CCCCCC',
    brightBlack:  '#555555', brightRed:     '#FF6369',
    brightGreen:  '#4ADE80', brightYellow:  '#FFB224',
    brightBlue:   '#74B3FF', brightMagenta: '#C084FC',
    brightCyan:   '#22D3EE', brightWhite:   '#FFFFFF',
  },
});

term.loadAddon(fitAddon);
term.loadAddon(webLinks);
term.open($('terminal-container'));
term.loadAddon(new WebglAddon.WebglAddon());

term.onData(data => {
  if (state.ws && state.ws.readyState === WebSocket.OPEN) state.ws.send(data);
});

// â”€â”€ Layout / fit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PILL_H + PILL_GAP must match CSS --pill-h and --pill-gap
const PILL_H   = 52;
const PILL_GAP = 10;

let resizeTimer;

function doFit() {
  try {
    fitAddon.fit();
    if (state.ws && state.ws.readyState === WebSocket.OPEN) {
      state.ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
    }
  } catch (_) {}
}

// Use visualViewport to correctly handle the on-screen keyboard.
// Updates terminal height and pill position so they stay above the keyboard.
function updateLayout() {
  const vv = window.visualViewport;
  if (!vv) { doFit(); return; }

  // How many px of keyboard is covering the bottom of the window
  const keyboardH = Math.max(0, window.innerHeight - (vv.offsetTop + vv.height));

  // Position pill just above the keyboard
  if (state.isMobile && state.sessionActive) {
    const pillBottom = keyboardH + PILL_GAP;
    mobileToolbar.style.bottom = pillBottom + 'px';

    // Shrink terminal-wrap so content isn't hidden behind the pill
    const pillarH = PILL_H + pillBottom;
    terminalWrap.style.paddingBottom = pillarH + 'px';
  }

  doFit();
}

// Listen on both window resize (desktop) and visualViewport resize (keyboard)
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(updateLayout, 80);
});

if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updateLayout, 80);
  });
  window.visualViewport.addEventListener('scroll', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updateLayout, 80);
  });
}

// â”€â”€ View switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLaunch() {
  launchScreen.classList.remove('hidden');
  terminalView.classList.add('hidden');
  mobileToolbar.style.display = 'none';
  document.body.classList.remove('mobile-show');
  terminalWrap.style.paddingBottom = '';
}

function showTerminal() {
  launchScreen.classList.add('hidden');
  terminalView.classList.remove('hidden');
  if (state.isMobile) {
    document.body.classList.add('mobile-show');
    mobileToolbar.style.display = '';
  }
  requestAnimationFrame(() => { updateLayout(); term.scrollToBottom(); });
}

// â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(type, text) {
  statusDot.className = 'status-dot ' + type;
  statusText.textContent = text;
}

// â”€â”€ Reconnect overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showReconnectOverlay() { reconnectOverlay.classList.add('visible'); }
function hideReconnectOverlay() {
  reconnectOverlay.classList.remove('visible');
  clearTimeout(state.reconnectOverlayTimer);
  state.reconnectOverlayTimer = null;
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Tear down whatever socket exists and start fresh.
function forceReconnect() {
  clearTimeout(state.reconnectTimer);
  clearTimeout(state.reconnectOverlayTimer);
  state.reconnectOverlayTimer = null;
  state.reconnectAttempt = 0;

  if (state.ws) {
    const old = state.ws;
    state.ws = null;
    old.onopen = old.onmessage = old.onclose = old.onerror = null;
    try { old.close(); } catch (_) {}
  }

  showReconnectOverlay();
  state.reconnectTimer = setTimeout(connect, 150);
}

async function connect() {
  // On reconnect (not first load), skip the doomed WS attempt entirely.
  // Mobile browsers block new WS connections while the stale TCP is dying.
  // Just confirm the server is up via HTTP, then reload the page.
  if (state.hasConnectedOnce) {
    try {
      await fetch(`/api/session?_=${Date.now()}`, { cache: 'no-store' });
      return location.reload();
    } catch (_) {
      scheduleReconnect();
      return;
    }
  }

  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(`${proto}//${location.host}/?_=${Date.now()}`);
  state.ws = ws;
  ws.binaryType = 'arraybuffer';

  const connectTimeout = setTimeout(() => {
    if (state.ws !== ws) return;
    try { ws.close(); } catch (_) {}
  }, 3000);

  ws.addEventListener('open', () => {
    clearTimeout(connectTimeout);
    if (state.ws !== ws) return;
    state.wsConnected = true;
    state.hasConnectedOnce = true;
    state.reconnectAttempt = 0;
    setStatus('green', 'Connected');
    hideReconnectOverlay();
    term.reset();
  });

  ws.addEventListener('message', evt => {
    if (state.ws !== ws) return;
    if (evt.data instanceof ArrayBuffer) {
      term.write(new Uint8Array(evt.data));
      return;
    }
    const raw = evt.data;
    let msg;
    try { msg = JSON.parse(raw); } catch (_) { term.write(raw); return; }

    if (msg.type === 'state') {
      state.sessionActive = msg.active;
      if (msg.active) {
        showTerminal();
      } else {
        showLaunch();
        term.clear();
        resetKillBtn();
        startBtn.disabled = false;
        startBtn.textContent = 'INITIALIZE';
      }
    }
  });

  ws.addEventListener('close', () => {
    clearTimeout(connectTimeout);
    if (state.ws !== ws) return;
    state.wsConnected = false;
    setStatus('amber', 'Reconnectingâ€¦');
    scheduleReconnect();
    if (!state.reconnectOverlayTimer) {
      state.reconnectOverlayTimer = setTimeout(showReconnectOverlay, 1000);
    }
  });

  ws.addEventListener('error', () => {
    clearTimeout(connectTimeout);
    if (state.ws !== ws) return;
    ws.close();
  });
}

function scheduleReconnect() {
  const delays = [500, 1000, 2000, 4000, 10000];
  const delay = delays[Math.min(state.reconnectAttempt, delays.length - 1)];
  state.reconnectAttempt++;
  clearTimeout(state.reconnectTimer);
  if (document.visibilityState === 'hidden') return;
  state.reconnectTimer = setTimeout(connect, delay);
}

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState !== 'visible') return;
  forceReconnect();
});

window.addEventListener('pageshow', e => {
  if (e.persisted) forceReconnect();
});

window.addEventListener('focus', () => {
  if (!state.wsConnected) forceReconnect();
});

setInterval(() => {
  if (document.visibilityState !== 'visible') return;
  if (state.wsConnected && state.ws && state.ws.readyState === WebSocket.OPEN) return;
  if (state.reconnectTimer) return;
  forceReconnect();
}, 3000);

// â”€â”€ Directory Browser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function browse(dirPath) {
  browserList.innerHTML = '<div class="browser-loading"><span class="browser-spinner"></span> Loadingâ€¦</div>';
  let data;
  try {
    const resp = await fetch(`/api/browse?path=${encodeURIComponent(dirPath)}`);
    data = await resp.json();
  } catch (err) {
    browserList.innerHTML = `<div class="browser-error">Network error: ${err.message}</div>`;
    return;
  }
  if (data.error) {
    browserList.innerHTML = `<div class="browser-error">${data.error}</div>`;
    if (data.path) { state.browsePath = data.path; renderBreadcrumb(data.path); }
    return;
  }
  state.browsePath = data.path;
  renderBreadcrumb(data.path);

  const frag = document.createDocumentFragment();
  if (data.parent) frag.appendChild(makeEntryRow('parent', 'â†©', '..', data.parent));
  for (const e of data.entries) {
    const full = data.path.replace(/\/$/, '') + '/' + e.name;
    frag.appendChild(makeEntryRow(e.type, e.type === 'dir' ? 'ğŸ“' : 'ğŸ“„', e.name, e.type === 'dir' ? full : null));
  }
  if (!data.entries.length && !data.parent) {
    const msg = document.createElement('div');
    msg.className = 'browser-loading';
    msg.textContent = 'Empty directory';
    frag.appendChild(msg);
  }
  browserList.innerHTML = '';
  browserList.appendChild(frag);
}

const ICON_FOLDER = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>`;
const ICON_FILE   = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`;
const ICON_UP     = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="14 9 9 4 4 9"/><path d="M20 20h-7a4 4 0 0 1-4-4V4"/></svg>`;

function makeEntryRow(type, _icon, name, targetPath) {
  const row = document.createElement('button');
  row.className = `browser-entry ${type}`;

  const left = document.createElement('div');
  left.className = 'entry-left';

  const ic = document.createElement('span');
  ic.className = 'entry-icon';
  ic.innerHTML = type === 'parent' ? ICON_UP : type === 'dir' ? ICON_FOLDER : ICON_FILE;

  const nm = document.createElement('span');
  nm.className = 'entry-name';
  nm.textContent = name;

  left.appendChild(ic);
  left.appendChild(nm);
  row.appendChild(left);

  if (targetPath) {
    row.addEventListener('click', () => browse(targetPath));
  } else {
    row.disabled = true;
  }
  return row;
}

function renderBreadcrumb(fullPath) {
  pathDisplay.textContent = '/' + fullPath.split('/').filter(Boolean).join('/');
}

// â”€â”€ CLI Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.runner-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.runner-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.selectedCli = btn.dataset.cli;
  });
});

// â”€â”€ Start Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
startBtn.addEventListener('click', async () => {
  if (!state.browsePath) return;
  startBtn.disabled = true;
  startBtn.textContent = 'INITIALIZINGâ€¦';
  try {
    const resp = await fetch('/api/session/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cwd: state.browsePath, cli: state.selectedCli }),
    });
    const data = await resp.json();
    if (!resp.ok) {
      alert(data.error || 'Failed to start session');
      startBtn.disabled = false;
      startBtn.textContent = 'INITIALIZE';
    }
  } catch (err) {
    alert('Network error: ' + err.message);
    startBtn.disabled = false;
    startBtn.textContent = 'INITIALIZE';
  }
});

// â”€â”€ Kill Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetKillBtn() {
  state.killConfirmPending = false;
  clearTimeout(state.killConfirmTimer);
  killBtn.textContent = 'âœ• End Session';
  killBtn.classList.remove('confirm');
}
killBtn.addEventListener('click', async () => {
  if (!state.killConfirmPending) {
    state.killConfirmPending = true;
    killBtn.textContent = 'Confirm?';
    killBtn.classList.add('confirm');
    state.killConfirmTimer = setTimeout(resetKillBtn, 3000);
  } else {
    resetKillBtn();
    try { await fetch('/api/session/kill', { method: 'POST' }); } catch (_) {}
  }
});

// â”€â”€ Mobile Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendKey(key) {
  if (state.ws && state.ws.readyState === WebSocket.OPEN) state.ws.send(key);
  if (navigator.vibrate) navigator.vibrate(8);
}

// Regular key buttons
document.querySelectorAll('.tb-btn[data-key]').forEach(btn => {
  btn.addEventListener('pointerdown', e => {
    e.preventDefault();
    sendKey(btn.dataset.key);
  });
});

// Ctrl sticky modifier
ctrlBtn.addEventListener('pointerdown', e => {
  e.preventDefault();
  state.ctrlMode = !state.ctrlMode;
  ctrlBtn.classList.toggle('ctrl-active', state.ctrlMode);
  if (navigator.vibrate) navigator.vibrate(8);
  // Focus the hidden input so keyboard stays up
  if (state.isMobile) { mobileInput.setAttribute('inputmode', 'text'); mobileInput.focus(); }
});

function clearCtrl() {
  state.ctrlMode = false;
  ctrlBtn.classList.remove('ctrl-active');
}

// â”€â”€ Compose Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const composeOverlay  = $('compose-overlay');
const composeScrim    = $('compose-scrim');
const composeTextarea = $('compose-textarea');
const composeSend     = $('compose-send');
const composeCancel   = $('compose-cancel');
const tbCompose       = $('tb-compose');

function autoResizeTextarea() {
  const vv = window.visualViewport;
  const availH = (vv ? vv.height : window.innerHeight) - 60; // 60px overhead (padding + border-radius)
  composeTextarea.style.height = 'auto';
  const natural = composeTextarea.scrollHeight;
  if (natural >= availH) {
    composeTextarea.style.height = availH + 'px';
    composeTextarea.style.overflowY = 'auto';
  } else {
    composeTextarea.style.height = natural + 'px';
    composeTextarea.style.overflowY = 'hidden';
  }
}

function updateComposeSize() {
  const vv = window.visualViewport;
  if (!vv) return;
  const keyboardH = Math.max(0, window.innerHeight - (vv.offsetTop + vv.height));
  composeOverlay.style.bottom = keyboardH + 'px';
  autoResizeTextarea();
}

function openCompose() {
  updateComposeSize();
  composeOverlay.classList.add('open');
  composeScrim.classList.add('visible');
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', updateComposeSize);
    window.visualViewport.addEventListener('scroll', updateComposeSize);
  }
  setTimeout(() => { composeTextarea.focus(); autoResizeTextarea(); }, 50);
}

function closeCompose() {
  if (window.visualViewport) {
    window.visualViewport.removeEventListener('resize', updateComposeSize);
    window.visualViewport.removeEventListener('scroll', updateComposeSize);
  }
  composeTextarea.blur();
  composeOverlay.classList.remove('open');
  composeScrim.classList.remove('visible');
  setTimeout(() => {
    composeOverlay.style.bottom = '';
    composeTextarea.style.height = '';
    composeTextarea.style.overflowY = '';
  }, 260);
}

function submitCompose() {
  const text = composeTextarea.value;
  if (text && state.ws && state.ws.readyState === WebSocket.OPEN) {
    state.ws.send(text + '\r');
  }
  composeTextarea.value = '';
  closeCompose();
}

tbCompose.addEventListener('pointerdown', e => {
  e.preventDefault();
  if (navigator.vibrate) navigator.vibrate(8);
  openCompose();
});

composeCancel.addEventListener('click', closeCompose);
composeScrim.addEventListener('click', closeCompose);

composeSend.addEventListener('pointerdown', e => {
  e.preventDefault();
  submitCompose();
});

composeTextarea.addEventListener('input', autoResizeTextarea);

// Cmd+Enter / Ctrl+Enter also submits
composeTextarea.addEventListener('keydown', e => {
  if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault();
    submitCompose();
  }
});

// â”€â”€ Mobile keyboard capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (state.isMobile) {
  $('terminal-container').addEventListener('click', () => {
    mobileInput.setAttribute('inputmode', 'text');
    mobileInput.focus();
  });

  mobileInput.addEventListener('input', () => {
    const val = mobileInput.value;
    if (!val) return;
    if (state.ctrlMode) {
      // Apply Ctrl modifier to first character
      const code = val[0].toLowerCase().charCodeAt(0) - 96;
      if (code >= 1 && code <= 26) sendKey(String.fromCharCode(code));
      else sendKey(val);
      clearCtrl();
    } else {
      sendKey(val);
    }
    mobileInput.value = '';
  });

  mobileInput.addEventListener('keydown', e => {
    let key = null;

    if (state.ctrlMode && e.key.length === 1) {
      const code = e.key.toLowerCase().charCodeAt(0) - 96;
      if (code >= 1 && code <= 26) {
        key = String.fromCharCode(code);
        clearCtrl();
        e.preventDefault();
        if (key) { sendKey(key); return; }
      }
    }

    if      (e.key === 'Backspace')   key = '\x7f';
    else if (e.key === 'Enter')       key = '\r';
    else if (e.key === 'Escape')      key = '\x1b';
    else if (e.key === 'Tab')         { key = '\t'; e.preventDefault(); }
    else if (e.key === 'ArrowUp')     key = '\x1b[A';
    else if (e.key === 'ArrowDown')   key = '\x1b[B';
    else if (e.key === 'ArrowLeft')   key = '\x1b[D';
    else if (e.key === 'ArrowRight')  key = '\x1b[C';

    if (key) { sendKey(key); e.preventDefault(); }
  });

  mobileInput.addEventListener('blur', () => {
    mobileInput.setAttribute('inputmode', 'none');
  });
}

// â”€â”€ Mkdir Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const mkdirScrim     = $('mkdir-scrim');
const mkdirModal     = $('mkdir-modal');
const mkdirInput     = $('mkdir-input');
const mkdirError     = $('mkdir-error');
const mkdirCreateBtn = $('mkdir-create-btn');
const mkdirCancelBtn = $('mkdir-cancel-btn');
const mkdirBtn       = $('mkdir-btn');

function openMkdir() {
  mkdirInput.value = '';
  mkdirError.textContent = '';
  mkdirCreateBtn.disabled = false;
  mkdirScrim.classList.add('visible');
  mkdirModal.classList.add('open');
  setTimeout(() => mkdirInput.focus(), 50);
}

function closeMkdir() {
  mkdirScrim.classList.remove('visible');
  mkdirModal.classList.remove('open');
  mkdirInput.blur();
}

async function submitMkdir() {
  const name = mkdirInput.value.trim();
  if (!name) return;
  if (name.includes('/')) { mkdirError.textContent = 'Name cannot contain /'; return; }

  const fullPath = state.browsePath.replace(/\/$/, '') + '/' + name;
  mkdirCreateBtn.disabled = true;
  mkdirError.textContent = '';

  try {
    const resp = await fetch('/api/mkdir', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: fullPath }),
    });
    const data = await resp.json();
    if (!resp.ok) {
      mkdirError.textContent = data.error || 'Failed to create folder';
      mkdirCreateBtn.disabled = false;
      return;
    }
    closeMkdir();
    browse(state.browsePath);
  } catch (err) {
    mkdirError.textContent = 'Network error';
    mkdirCreateBtn.disabled = false;
  }
}

mkdirBtn.addEventListener('click', openMkdir);
mkdirCancelBtn.addEventListener('click', closeMkdir);
mkdirScrim.addEventListener('click', closeMkdir);
mkdirCreateBtn.addEventListener('click', submitMkdir);
mkdirInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); submitMkdir(); }
  if (e.key === 'Escape') { e.preventDefault(); closeMkdir(); }
});

// â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  const resp = await fetch('/api/session').catch(() => null);
  const session = resp ? await resp.json().catch(() => null) : null;
  browse((session && session.cwd) ? session.cwd : '');
})();

connect();
</script>
</body>
</html>
